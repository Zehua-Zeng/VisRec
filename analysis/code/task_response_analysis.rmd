---
title: "task_response_analysis"
output: html_document
---

```{r libraries, message=FALSE, warning=FALSE}

knitr::opts_chunk$set(fig.align="center") 
library(rstanarm) #bayesian analysis package
library(tidyverse) #tidy datascience commands
library(tidybayes) #tidy data + ggplot workflow
library(modelr) #tidy pipelines for modeling
library(ggplot2) #plotting package
library(gganimate) #animate ggplots\
library(magrittr)  
library(emmeans)

theme_set(theme_light()) # set the ggplot theme for all plots 

```


###Read in data

```{r data_prep}

mydata = read.csv('processed_ptask_responses.csv')
time_data = read.csv('processed_completion_time.csv')
analyses = c("confidence.udata", "confidence.ans", "efficiency", "ease.of.use", "utility", "overall")
```

```{r posterior_plotting_function}
generate_posterior_plot = function(model, num_independent_variables, filename, x_lab, facet=TRUE) {
  
  fit_info = f %>%
    mean_qi(.value)
  
  f = model %>%
    emmeans( ~ x1*x2*x3) %>%
    gather_emmeans_draws()
  
  if (facet){
    f$condition = paste(f$x2, f$x3, sep= " | ")
  }
  else{
    f$condition = paste(f$x1, f$x2, f$x3, sep= " | ")
  }
  #plot = ggplot(f, aes(x = .value, y = condition, color = x2)) +stat_halfeye()
  plot = ggplot(f, aes(x = .value, y = reorder(condition, desc(condition)), fill = x3)) + stat_halfeye() + 
    labs(x=x_lab, y="Condition")
  if(facet){
    plot = plot + facet_grid(cols = vars(x1))
  }
  ggsave(file=paste(filename, ".png", sep=""), plot=plot, path = "../plots/posterior_plots", width = 6, height = 4, dpi = 300, units = "in")
  
  write.csv(fit_info, paste("../plot_data/",filename,".csv", sep=""), row.names = FALSE)
}
```

## Specify model (using stan_glm(y ~ x1 * x2 * x3))
```{r specify_model}

run_model_3_var = function(data, attr, split, response, a_prior, a_sd, x_lab){
  #select your independent and dependent variables
  if(split){
    data$x1 = as.factor(data[,response])
    data$x2 = as.factor(data$oracle) 
    data$x3 = as.factor(data$search)
    data$y = data[,attr]
    
  }
  else{
    data$x1 = as.factor(data[,response])
    data$x2 = as.factor(data$dataset)
    data$x3 = as.factor(data$condition)
    data$y = data[,attr]
  
    # label the axes on the plots
    # x_lab = "Task"
    # y_lab = attr
    # fill_lab = "Condition"
  }
  
  b1_prior = 0
  b1_sd = a_sd 
  
  m = stan_glm(y ~ x1*x2*x3, data = data,
  prior_intercept = normal(a_prior, a_sd, autoscale = FALSE),
  prior = normal(b1_prior, b1_sd, autoscale = FALSE))
  
  filename = gsub("\\.", "_", attr)
  if(split){
    filename = paste(filename, "_split", sep="")
  }
  
  generate_posterior_plot(m, 3, filename, x_lab, FALSE)

}

for (attr in analyses){
    run_model_3_var(mydata, attr, FALSE, "task", 0, 1, "User Score")
    run_model_3_var(mydata, attr, TRUE, "task", 0, 1, "User Score")
}

```

```{r time_analysis}  
run_model_time = function(data, task, a_prior, a_sd){
  #select your independent and dependent variables
  data$x1 = as.factor(data$dataset) 
  data$x2 = as.factor(data$oracle)
  data$x3 = as.factor(data$search)
  data$y = data$time
  
  b1_prior = 0
  b1_sd = a_sd 
  
  m = stan_glm(y ~ x1*x2*x3, data = data,
  prior_intercept = normal(a_prior, a_sd, autoscale = FALSE),
  prior = normal(b1_prior, b1_sd, autoscale = FALSE))
  filename = gsub(" ", "_", task)
  filename = paste("time_", filename, sep="")
  generate_posterior_plot(m, 3, filename, "Time (Seconds)", FALSE)

}

run_model_time(subset(time_data, task == "1. Find Extremum"), "Find Extremum", 190.34, 96.57)
run_model_time(subset(time_data, task == "2. Retrieve Value"), "Retrieve Value", 313.37, 88.50)
run_model_time(subset(time_data, task == "3. Prediction"), "Prediction", 870.53, 657.68)
run_model_time(subset(time_data, task == "4. Exploration"), "Exploration", 693.13, 193.30)

```

```{r analysis_focused_or_open}  

run_model_time = function(data, task, a_prior, a_sd){
  #select your independent and dependent variables
  data$x1 = as.factor(data$dataset) 
  data$x2 = as.factor(data$oracle)
  data$x3 = as.factor(data$search)
  data$y = data$time
  
  b1_prior = 0
  b1_sd = a_sd 
  
  m = stan_glm(y ~ x1*x2*x3, data = data,
  prior_intercept = normal(a_prior, a_sd, autoscale = FALSE),
  prior = normal(b1_prior, b1_sd, autoscale = FALSE))
  filename = gsub(" ", "_", task)
  filename = paste("time_", filename, sep="")
  generate_posterior_plot(m, 3, filename, "Time (Seconds)")

}

run_model_time(subset(time_data, task_type == "Focused"), "Focused", 251.85, 106.79)
run_model_time(subset(time_data, task_type == "Open-Ended"), "Open-Ended", 781.83, 444.30)


run_model_3_var = function(data, attr, response, a_prior, a_sd, x_lab){
  #select your independent and dependent variables

    data$x1 = as.factor(data[,response])
    data$x2 = as.factor(data$oracle) 
    data$x3 = as.factor(data$search)
    data$y = data[,attr]
    
  
  b1_prior = 0
  b1_sd = a_sd 
  
  m = stan_glm(y ~ x1*x2*x3, data = data,
  prior_intercept = normal(a_prior, a_sd, autoscale = FALSE),
  prior = normal(b1_prior, b1_sd, autoscale = FALSE))
  
  filename = gsub("\\.", "_", attr)
  filename = paste(filename, "_split_task_type", sep="")
  
  generate_posterior_plot(m, 3, filename, x_lab)

}

for (attr in analyses){
    run_model_3_var(mydata, attr, "task_type", 0, 1, "User Score")
}
```

```{r accuracy_analysis}  
time_data = read.csv('processed_completion_time.csv')

run_model_time = function(data, task, a_prior, a_sd){
  #select your independent and dependent variables
  data$x1 = as.factor(data$dataset) 
  data$x2 = as.factor(data$oracle)
  data$x3 = as.factor(data$search)
  data$y = data$completion_time
  
  b1_prior = 0
  b1_sd = a_sd 
  
  m = stan_glm(y ~ x1*x2*x3, data = data,
  prior_intercept = normal(a_prior, a_sd, autoscale = FALSE),
  prior = normal(b1_prior, b1_sd, autoscale = FALSE))
  filename = gsub(" ", "_", task)
  filename = paste("time_", filename, sep="")
  generate_posterior_plot(m, 3, filename, "Time (Seconds)")

}

run_model_time(subset(time_data, task == "1. Find Extremum"), "Find Extremum", 190.34, 96.57)
run_model_time(subset(time_data, task == "2. Retrieve Value"), "Retrieve Value", 313.37, 88.50)
run_model_time(subset(time_data, task == "3. Prediction"), "Prediction", 870.53, 657.68)
run_model_time(subset(time_data, task == "4. Exploration"), "Exploration", 693.13, 193.30)

m %>%
  emmeans( ~ y) %>%
  gather_emmeans_draws() %>%
  mean_qi()

```




